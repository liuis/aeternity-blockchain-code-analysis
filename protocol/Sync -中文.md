# Sync

任何区块链的最基本构建块是用于跟踪状态转换的ledger。如果我们所关心的只是将这个ledger保留在我们的本地机器上，那么我们就不需要做更多的工作，但只要有更多的参与方，事情往往会更有趣。一旦涉及多方，就需要distributed ledger，这需要我们与其他人进行通信并交换有关状态转换的信息，以便同步其本地状态机。

本文档描述了一组对等体如何在对等体可能不相互信任或甚至可能恶意行为的设置中交换有关状态转换的信息。

考虑到这一点，我们将不得不提出一种协议，最大限度地减少攻击面，同时不会（显着）妨碍在网络中传播信息的速度。

我们可以通过几个维度调整协议：

- 网络带宽使用

- 事务/块传播的网络延迟

- 可靠性（在对手面前）

- 内存/ CPU使用率

但几乎总是如此，我们不能充分利用它们。

理想情况下，我们的协议具有旋钮，允许用户配置它以满足他们的需要，例如：在移动电话上运行的节点可能希望以增加的延迟为代价来减少带宽，或者在频谱的另一端，强节点可能会选择通过使用更多的网络带宽和增加的CPU使用来减少延迟。

## Transport protocol

此初始版本将使用TCP连接的节点。所有通信都将被加密和验证，以确保机密性和完整性，从而防止攻击者在一定程度上干扰协议和节点的去匿名化。

对于加密和认证，我们将使用Noise协议，确切的协议名称为Noise_XK_25519_ChaChaPoly_Blake2b，即握手时的XK，Curve25519上的DH，对称加密的ChaChaPoly和Blake2b哈希函数。 XK作为握手模式意味着握手的发起者将其静态密钥发送给响应者，并且发起者知道响应者的静态密钥。

每个节点都有一个用于P2P通信的静态Curve25519密钥对。通过在节点配置中具有一组Aeternity对等地址来引导对等体发现，并且节点在启动节点之后尝试连接到这些对等体。对等地址如下所示：aenode：//pp_ttZZwTS2nzxg7pnEeFMWeRCfdvdxeRu6SgVyeALZX3LbdeiWS@31.13.249.0：3015。

（TODO：拼出完整的协议，包括关键时间表等）

## Peer to peer network

（TODO：这应该是本文档的首要主题，同步是一个子主题）

假定参与网络的所有节点将保留所有可用数据，则不需要具有结构化覆盖网络。

[这里](https://github.com/aeternity/protocol/blob/master/sync/p2p_messages.md)概述了P2P消息协议。

引导
在任何节点开始下载区块链的过程之前，它需要发现合适的邻居，这些邻居是对等网络的一部分。我们考虑两种不同的方法来引导这个过程：

 1.有一个中央服务，分发一组初始邻居，例如 通过DNS查找。
 .have a central service, that hands out an initial set of neighbours, e.g. via a DNS lookup

 2.使用一组初始邻居发送节点软件。ship the node software with a set of initial neighbours

两种选择都有优点和缺点。

第一个意味着可以轻松地轮换初始邻居集，而无需更新任何配置文件，但这决于相当集中的基础架构。 选项二不依赖于DNS，但如果初始邻居集需要更改，则需要按顺序更新节点软件包。

我们将根据偏好顺序选择以下策略之一来获取网络的初始入口点：

1.查询节点之前与之交谈的对等体的本地数据库并尝试连接它们

2.连接到具有DNS条目的已知对等体列表

3.依赖节点包附带的硬编码节点

## Neighbour selection

在一个节点被引导后，它应该尝试保持一个相当稳定的邻居，从而尝试在重启时保持对等体。

为了描述选择过程，我们需要提出用于邻居替换的策略和用于从集合中挑选可能的新对等体的偏好函数。

选择选择策略会对网络的整体运行状况产生很大影响，因为它会影响节点程度，进而控制弹性和消息开销。

有丰富的文献分析基于对等覆盖网络固有的价值的不同策略，例如：对等年龄或行为度量，或基础网络的值，例如， RTT或地理位置。

基于年龄的替代策略可分为两类：

活性：
被动：
文献中已经讨论了许多不同的选择策略，但为了选择正确的选择策略，我们需要首先提出要求。

## 路由Routing

在比特币和以太网网络中，路由无关紧要，因为通常不可能说，谁将产生下一个块，因此用户只需将交易发布到网络，希望能够覆盖所有矿工，然后可以拿起它。

鉴于我们使用Bitcoin-NG [7]协议，路由层可能对具有严格时序要求的用户感兴趣，或者只是为了改善用户体验，因为当事务可以直接路由到目前的圆形领导者与洪水泛滥的网络。

路由的添加将在本文档的未来版本中解决。

## 搅动 churn 

有许多研究观察和研究对等网络中的流失模式，如Gnutella或BitTorrent。虽然在这种情况下考虑这些肯定是有价值的，但我们可以假设使用模式差异很大，因为它们主要用于共享相对较小的自包含文件。

Donet等[8]在2013年对比特币点对点网络进行了早期研究，发现“872648个不同的IP地址对应于运行比特币节点的机器”。但在37天的观察期后，仍然只能达到惊人的0.66％（5759）。 bitnodes一直试图跟踪对等网络的大小，从2016年5月开始，大约有6500个节点。

## Connection

incoming/outgoing

whitelist/blacklist

## Incentives激励

节点与其他节点共享交易和阻止的动机很弱，并且有大量研究表明，对于Nakamoto风格的共识，不立即分享新块可能会让矿工感兴趣。 [1][2]这些缺点也激励了矿业集权的集中化，这是我们想要避免的。

另一个例子是挖掘池，它希望尽可能快地接收有关新块和事务的信息，因此可能放弃彻底检查块的有效性以减少延迟。这显然不符合网络的利益。

（TODO：想出类似于/基于TorCoin的东西，或至少提及它并展示如何整合它。）

阻止/事务同步
在启动时（在发现至少一个其他Peer之后），节点将同步链和未确认事务的当前列表。

同步链（可能）是一项大任务，节点将利用其所有连接的对等方来获取块和事务。

（TODO：写下Aeternity节点实现的详细说明。）



## Block/Transaction 同步

在启动时（在发现至少一个其他Peer之后），节点将同步链和未确认事务的当前列表。

同步链（可能）是一项大任务，节点将利用其所有连接的对等方来获取块和事务。

（TODO：写下Aeternity节点实现的详细说明。）

同步未确认的事务是一个较小的任务，节点将选择另一个对等体并同步该对等体（仅缺少的）事务。同步使用MP树 - 这里（tx_pool_sync.md）有更详细的描述。

## Block/Transaction 传播

- 使用比特币-ng总是发送完整的块将是一个巨大的浪费

- 向peers宣布新的tx / block

- 如果没有数据，peer会询问数据

- 不必发送所有tx的完整块

- 首先发送标头

- 考虑发送单个tx与批处理的开销

### POW 工作证明拼图

节点operators可以选择连接对等体来解决工作证明谜题作为速率限制的手段。如果他们认为是eclipse攻击或拒绝服务的目标，他们应该使用这个选项。

这种拼图的解决方案既可以离线生成，也可以在线生成，两者都有其优点。

能够离线生成解决方案将为资源受限节点提供轻松参与的可能性，但也允许攻击者在攻击之前生成许多解决方案。这种离线方案的一个例子可能是找到Blake2b（CuckooCycle（Pubkey || Nonce））> DifficultyTarget的解决方案。在连接时，对等体将呈现随机数，然后连接的接收器可以验证用于与随机数串联的噪声握手的静态密钥确实是有效的解决方案。 （TODO：这可能需要一个共识值，否则节点不会知道会发生什么）

Juels和Brainard [6]是第一个引入交互式方案的人，他需要解决计算难题来对抗拒绝服务攻击。

在建立安全会话之后，连接节点需要发送的第一条消息是发送其工作证明解决方案。

- 这可以是互动的

  1. initiator连接到节点

  2. 响应者发送挑战

  3. 启动器断开连接

  4. 发起人计算解决方案

  5. initiator再次连接并提供解决方案

如果大多数节点需要过于困难的pow 拼图，可能会出现问题，因为它可能会阻止大多数人运行节点并损害网络的健康。

### 声誉 Reputation

同步协议为对等体使用一个非常简单的信誉系统，它只用于惩罚发送垃圾或行为不端的对等体。信誉是节点的本地信誉，不与任何人共享。一旦违规节点达到某个阈值，例如0，被冒犯的节点可以终止连接，并且应该拒绝罪犯进行任何进一步的连接尝试，例如， 24小时，如果他们选择惩罚他们。

此内容中的垃圾将是：

- 无效的块
- 无效的交易
- ...

如果罪犯有动机并且愿意提出更多节点，则受到攻击的节点可能需要连接节点，以便在接受之前解决工作量证明难题。



## 配置属性 Configurables

- pow target
- pow wait timeout
- (listener interface, port)
- connection timeout
- \#overall connections
- \#incoming connections
- gossip pool size
- peers -> (blacklist, whitelist)

## 威胁模型 Threat Model

任何威胁模型都带有一组超出范围的假设和攻击向量。

第一个假设是，我们的distributed ledger是一个区块链，使用Nakamoto风格的共识和领导者选举的工作证明，任何恶意矿工不拥有超过网络挖掘能力的25％。这保证了我们的ledger的基本完整性。 （TODO：正确解决自私采矿等问题）

此处描述的协议不用于传输任何机密，例如控制硬币的加密密钥，但确实使用加密密钥本身。对于攻击者而言，他们能够通过使用它们的节点来启动协议。鉴于协议仅用于传输公共信息并且生成新密钥很容易，这应该只是一个小小的不便。 （TODO：如果我们也使用它们进行身份验证，则会发生变化）

在上述假设下，我们不考虑参与协议的节点的任何物理威胁，并且因为它通常被认为是一个非常难以解决的问题，试图设计可以处理受损端点的协议[4]。可以考虑使用安全区域和其他专用硬件进行缓解，但这里不再讨论。

也就是说，我们在RFC3552 [4]第3节中概述的“Internet威胁模型”下运行：

> 一般而言，我们假设参与协议交换的终端系统本身并未受到损害。当其中一个终端系统受到攻击时，防止攻击非常困难。但是，可以设计协议，以最小化在这些情况下造成的损害程度。
>

> 相比之下，我们假设攻击者几乎完全控制了终端系统通信的通信信道。这意味着攻击者可以读取网络上的任何PDU（协议数据单元），并且不可检测地将伪造的数据包移除，更改或注入到线路上。这包括能够生成看似来自受信任计算机的数据包。因此，即使您希望与之通信的终端系统本身是安全的，因此Internet环境也不能保证声称来自该系统的数据包实际上是。
>

我们进一步限制此模型并排除TCP和IP级别（分布式）拒绝服务攻击，例如， SYN泛滥或任何类型的放大攻击。

## Transport

传输消息使用Noise协议进行加密和验证。有关Noise协议及其安全保证的深入讨论，请参阅文档，特别是第7节和第14节。使用加密和身份验证涵盖中间人攻击，窃听，

拒绝服务（DoS）攻击可以安装在不同的层，例如，在协议或节点级别。

- 减慢块传播

  - 增量叉子的风险

  - 使自私的采矿更有利可图

- 通过耗尽所有connections/填充RAM来节省单个节点的资源

安全：

- eclipse攻击 - >接受双倍花费

隐私：

- 同一网络中的任何人基本上都可以看到你没有加密的一切

网络级分布式拒绝服务（DDoS）攻击试图通过使其与互联网的连接饱和而使节点脱机，但这种攻击超出了范围，尽管可以认为使用混合网络隐藏了通信方的IP地址，因此可能会减轻一个DDoS角度。

### 资源枯竭Resource exhaustion

### Eclipse攻击

每当攻击者设法用对抗性节点包围一个诚实的节点时，我们就会谈到日食攻击。

为了防止恶意方使用请求充斥网络并潜在地消除新节点，我们将要求节点在尝试启动与另一节点的连接时将解决方案附加到工作证明谜题。这个解决方案.