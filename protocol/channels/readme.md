＃州立频道

状态通道允许实体以目标相互通信
集体计算一些函数`f`。
这个`f`可以像“每分钟发送0.1个硬币”一样简单，也可以代表
分散交换。在我们的例子中，这些功能由智能代表
合同，就像任何合法合同一样，我们需要一方仲裁
试图恶意行事。这个仲裁者是区块链。

 - 不信任
 - 断链与链
 - 与区块链相同的保证

在描述所涉及的协议之前，我们将介绍一些高
水平问题，塑造了我们的国家渠道设计。


＃＃ 目录

 -  [条款]（＃条款）
 -  [记谱法]（＃记谱法）
 -  [目标]（＃goal）
 -  [隐私]（＃privacy）
 -  [安全]（#security）
 -  [速度]（＃速度）
 -  [费用]（#cost）
 -  [频道类型]（＃频道类型）
 -  [拓扑]（＃拓扑）
 -  [奖励]（＃奖励）
 -  [Artefacts]（＃artefacts）
 -  [费用]（＃费用）
 -  [协议]（＃协议）
 -  [通讯]（＃通讯）
 -  [概述]（＃概述）
 - 消息
 -  [Off-chain]（。/ OFF-CHAIN.md）
 -  [On-chain]（./ ON-CHAIN.md）
 -  [合同在渠道中执行]（＃合同执行）
 -  [灯节点要求]（＃灯节点要求）
 -  [例子]（＃例子）
 -  [未来工作]（＃future-work）
 -  [参考文献]（＃参考）


##条款

我们尝试遵循闪电网络使用的命名约定，无论在哪里
这是有道理的，希望能够让其他人更容易采纳，
虽然我们试图强制执行命名的“谁 - 怎么样”规则，例如
`channel_close_solo`与`solo_close_channel`或`channel_solo_close`相对。

 -  ***节点***：连接到区块链的客户端，可以通过
  IP地址和端口
 -  *** peer ***：频道中的参与者
 -  *** channel ***：两个对等方交换状态更新的离线方法，
  每个节点可以有多个通道，也可以有一对节点
  彼此之间的多个通道，应该多路复用
  连接


##表示法

区块链上的所有对象都有一个类型，并且是唯一可寻址的。我们会
用'Type（Id）'表示这个，例如`帐户（A）`是地址`A`的帐户。如果
然后我们想要得到帐户的余额我们使用`帐户（A）.balance`。


##目标

 - 支持所有智能合约的通用解决方案
 - 如果一个国家频道是通用的，甚至更好，s.t。它可以实例化
然后用于许多不同的合同
 - 频道的可组合性，即应用程序适用于
  < - > B情况也应该在A <-B-> C（A到C通过B）的情况下工作
 - 无需关闭/重新打开频道即可升级
 - 前一个应该使状态通道长寿
 - 这与隐私不一致
 - 应将链条操作保持在最低限度
 - 参与者状态也应保持在最低限度，即O（log n）或更好
  常数乘数
 - 使用区块链作为仲裁者，在一定程度上减少信任
 - 任何参与方都可以关闭频道，但不应该这样做

一般来说，理想的状态通道设计应该是一个严格的改进
处理链上的交互。我们将用于衡量的维度
改进如下：

 - 隐私
 - 安全
 - 速度
 - 成本


###隐私

由于我们目前没有，因此链上互动几乎没有提供任何隐私
努力隐藏互动方或其互动的性质。

国家渠道至少表明双方建立了一个渠道和渠道
他们投入渠道的硬币数量，没有任何改善。
在没有一方试图欺骗的情况下，他们的确切性质
交互保持未透露，因为通道的相互关闭不会
要求发布任何州。

考虑到这一点，国家频道在隐私方面略有改善。


###安全

国家频道提供与正常链路几乎相同的安全保障
交易。

 -  ***生活***：两个同伴可以独立发起关闭一个频道和
  然后，区块链使用通常的假设处理该操作
  活泼。
 -  ***无信任***：因为运营需要由同行和他们签署
  根据他们对国家的看法签署行动，双方都只会
  签署他们同意的操作，不需要信任其他同行。

因此安全性与此相当。


###速度

打开状态通道会导致正常的链上延迟但在通道之后
已经建立，运营可以像双方一样快地执行
处理它们，这应该是对链上相互作用的重大改进。


###成本

使用状态通道至少需要两个链上事务才能打开
并关闭它们。一旦建立了一个渠道，就没有进一步的链上
除非同行想要提取或存入资金，否则需要进行交易。甚至
在一次性交易的情况下，仍然可能值得开通频道
如果一个人已经拥有其他开放渠道，那么可能会获得收费
转发消息。


##频道类型

最通用的通道类型是允许对等实例化任何通道的通道
渠道内的任意智能合约并不限制数量
可以参与这样一个频道的同伴。

我们的建筑将尝试满足前一个属性，允许任何数量的
任意智能合约在渠道中执行，但限制后者
每个频道两个对等点。这种限制主要是为了保持频道
施工简单。当然可以有两个以上的参与者
每个频道，要求所有人都注销每次更新，但这会产生
开销很大，导致频道卡住的可能性增加，
只要对等方停止响应。有一些方法可以避免活跃问题
但是在那时我们还不清楚我们是否还在运营一个国家频道
或已经处理过侧链。

考虑到这一点，一个频道中的两个同伴很可能没有
相同的角色，但最终在大多数的客户端 - 服务器安排
通道，客户端使用服务器提供的服务，即
高度可用，也可能是一些众所周知的实体，反映了地位
当前网络的现状。
一个流行的例子是交换，用户通过交换机连接到交换机
国家渠道。这个过程将是无信任的，因为交流不能
失去资金，尚未签署给他们


##拓扑

目前还很不清楚，广泛使用的频道的拓扑结构是什么
网络看起来像，但似乎一个中心辐射模型
最有可能的。这个模型似乎比分散的模型更可能因为
大多数用户将无法提供可靠的服务，更长的路径
通过网络将锁定更多的资金，表面上也是如此
收取更高的转发费。

在轮辐模型中，我们会有许多大型集线器
通过网络参与大多数路线。这些中心将是紧密的
连接并为大多数用户提供高可用性和短路径。反过来，这将导致隐私的丧失，并使网络更加脆弱，因为
其中一个中心的消失将对其整体产生重大影响
连通性。


##奖励

操作频道需要至少两次链上操作，因此需要基本的费用，这个事实可能会被恶意滥用
同行。
由于关闭频道需要付费，他们可以与某人打开频道
随后拒绝合作，锁定硬币并制造另一方
支付再次关闭频道所需的费用。

一旦打开了一个频道，就需要进行所有正在进行的操作
所有参与者签字。这为任何人创造了一个免费选择
最后签署更新。强制执行的能力可以解决这个问题
链条上的进展，即从渠道获取国家并拥有矿工
执行合同电话，另一方不愿意签字。

考虑到这一点，建议用户对他们打开的人保持谨慎
渠道，如果他们想避免上述问题。

另一方面，将渠道中的每个失败归咎于恶意也是如此
是有害的，导致失去对系统和用户的信任
比他们应该更多的费用。


##人工制品

国家频道的结果应该是什么？最简单的答案是
参与者的链上余额发生变化，但也可能需要
使用州渠道作为穷人的MPC并与非空的合同
作为链条上的结果，理想情况下，需要一个紧凑的证据，
给定的智能合约实际上产生了由国家提供的国家
参与者。


＃＃ 费用

如果我们将状态通道视为长寿命对象，则可能会出现问题
在处理费用方面，需要为连锁交易支付费用。

鉴于所有各方都需要签署所有协议，恶意方可以
在某些情况下，潜在的黑人邮件给同行。
如果费用来自渠道余额，那么可能会出现情况，
渠道余额低于矿工提取所需的费用
交易。这里的结果是，黑邮邮件的同行会减少损失
硬币比一个连锁交易的成本，这应该不是很多。
如果费用来自发送交易的帐户，那么
帐户可能最终没有足够的硬币，因此最终可能会结束
资金不足以关闭渠道。这可能会更糟糕
渠道可能会持有大量资金。

在这种情况下，似乎直接从渠道余额中扣除费用作为其结束的一部分似乎是最明智的方法。

为了避免这种情况，如果链上费用达到某一点，同行应该考虑暂停任何互动，并及时关闭渠道所需的费用
方式接近渠道的平衡。


＃＃ 协议

关键词“必须”，“绝不”，“必须”，“应该”，“不要”，“应该”，
本文档中的“不应该”，“推荐”，“可能”和“可选”应为
解释如[RFC 2119]（https://tools.ietf.org/html/rfc2119）中所述。


###沟通

频道参与者之间的通信是点对点的，应该是
通过可靠且有序的协议发生，例如TCP。同行应该期待
运行自己的节点，以便能够捕获与之相关的事务
他们参与的渠道虽然将这项工作外包给第三方，但仍然没有信任，但未来可能会成为可能。

参与状态信道需要两个节点能够通信
彼此。在整个文档中，我们将假设这一点
通过TCP / IP发生。
发现远程节点的“IP_ADDR：PORT”对的过程不是
本文档中涉及并假设在带外发生，除非它们都已经是状态通道网络的一部分，其中节点可以宣告它们的身份`（IP_ADDR，PORT，ID）。

消息将在链上和链外发送。

离线通信必须加密。为了满足这一点，我们使用相同的
用于同步的传输协议，提供加密和身份验证
基于噪声协议。

每对节点应该至多有一个开放连接。频道可以
考虑到每个通道都有唯一的ID，因此可以轻松复用，因此可以重复使用
连接不会造成任何问题。


###概述

下图应概述脱链状态机。
任何渠道的起点都是“关闭”状态。

```
+ --- + channel_open + --- +
| | -------------> + ------------- +错误| |
| | |初始化| ------------------------------------> | |
| | <------------- + ------------- + | |
| | [超时] / | channel_accept | |
| | [断开] v | |
| | + ------------- +错误| |
| | <------------- |接受| ------------------------------------> | |
| c | [timeout] / + ------------- + | e |
| l | [断开] | funding_created | r |
| o | v | r |
| s | + ------------- +错误| o |
| e | <------------- | half_signed | ------------------------------------> | r |
| d | [timeout] / + ------------- + | |
| | [断开] | funding_signed | |
| | v | |
| | + ------------- + [disconnect] | |
| | <------------- |签名| ------------- +错误| |
| | [timeout] + ------------- + ------------- | ------------------ ----> | |
| | | |关机| | |
| | funding_locked | + ------------ + | | |
| | | | | | |
| | | | v | |
| | v [disconnect] + -------------- + error | |
| | + ------------- + --------- |  - > |断开连接| ------> | |
| | <------------- |打开| | + -------------- + | |
| | [timeout] + ------------- + <-------- | ------------ + | |
| | ^ | | channel_reestablish | |
| |更新_ * / | | | | | |
| | ping / pong +  -  + |关闭v | |
| | | + ------------- + [disconnect] | |
| | +  - > |关闭| ------------ + | |
| | + ------------- + | | |
| | | ^ | | |
| | | | channel_reestablish | | |
| | <------------------------------ + | v | |
| | closing_signed | + -------------- +错误| |
| | + -------- |断开连接| ------> | |
+ --- + + -------------- + + --- +
  ^ |
  | |
  + ------------------------------------------------- ------------------------- +
```

***注意***：方括号`[]`中的术语不是由定义的显式消息
协议，但是底层传输协议的一部分。


在链

```
+ --- + channel_create
| | --------------------------------> + -------------- +
| | |打开|
| | <-------------------------------- + -------------- +
| | channel_close_mutual | ^ | channel_withdraw /
| | | | | channel_snapshot_solo /
| | channel_close_solo | | | channel_deposit /
| | | | | channel_force_progress
| | | | |
| c | | | |
| l | channel_close_mutual | +  -  +
| o | <------------------- + -------------- + |
| s | |关闭| |
| e | <------------------- + -------------- + |
| d | channel_settle | ^ |
| | | | |
| | channel_slash / | [LOCK_TIMEOUT] |
| | channel_force_progress | | |
| | | | |
| | v | |
| | channel_close_mutual + -------------- + |
| | <------------------- |锁定| < -  +
| | + -------------- +
+ --- + | ^
                            | |
                      channel_slash /
                  channel_force_progress
                            | |
                            +  -  +
```

***注意***：`[lock_timeout]`不是协议的显式消息，而是
计时器到期。

###合同执行

离线合同生命周期紧密代表着链式合同。合同
是通过共同签署的脱链交易创建的。一旦完成，新的
合同可以由两个渠道参与者调用。每份合同都有自己的合同
状态和余额，可以通过合同调用进行修改。
每一轮都会清除合同电话。如果最后一轮包含一个电话，
它将是调用树的一部分，否则树将为空。
不同的客户端实现可以为参与者保留旧的调用
能够检查它们的返回值但这不是协议的一部分。
参与者可以从渠道的状态树中删除离线合同
重新分配它们之间的平衡。

状态通道的每个参与者保持表示该状态的状态树
内部渠道的状态。这棵树由账户，合同和
合同电话。虽然这个树是通道的内部，但在争议期间
解决方案，部分内容在链上发布，以便使用区块链作为
仲裁者。尽管在大多数情况下合同都是内部合同，但并非总体而言
案例。隐私可以进一步改善。

合同呼叫执行依赖于两个参与者同意状态更新。
在任何时候参与者都可能失踪或拒绝合作有效
脱链合同电话。我们称之为争议，可以使用
强迫进步链。这要求强制方提供足够的
合同执行的信息。成功的力量的结果
进步是一个新的渠道脱链国家。这样我们就可以保持合同了
渠道不信任。

##灯节点要求


＃＃ 未来的工作


##参考文献

[1]：Lightning Network RFC：https：//github.com/lightningnetwork/lightning-rfc

[2]：米勒，安德鲁等人。 “Sprites和State Channels：支付网络比闪电更快。”

[3]：Malavolta，Giulio，et al。 “支付频道网络的并发性和隐私性。” 2017年ACM SIGSAC计算机和通信安全会议的会议记录。 ACM，2017年。

[4]：Dziembowski，Stefan，et al。 PERUN：通过加密货币的虚拟支付渠道⋆。 IACR Cryptology ePrint Archive，2017：635,2017。

[5]：Roos，Stefanie，et al。 “快速和私密的结算付款：基于路径的交易的高效分散路由。” arXiv preprint arXiv：1709.05748（2017）。

[6]：Tremback，Jehan和Zack Hess。 “通用支付渠道。” （2015年）。
